
@model RoleVM



<div class="row">

    <div id="listContainer" class="col-md-12 col-sm-12 col-xs-12">

        @using (Html.BeginForm("CreateOrEdit", "Roles", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "", role = "form" }))
        {
            <div id="rolename">
                <div class="col-5" style="margin: auto; padding: 0%; ">
                    <h4 style="text-align: center;">Elija el role a editar</h4>

                    <select name="Role.Role.IdRole" id="role-select" class="form-control form-control-lg">
                        <option value="0">Seleccione un role</option>

                        @foreach (var role in Model.ListaRoles)
                        {
                            <option value="@role.IdRole">@role.Nombre</option>
                        }
                    </select>
                </div>

            </div>
            <br />


            @*<div class="container py-5">

                <div class="py-5">
                    <div class="row">

                        <div class="col-lg-6 mb-5">

                            <a data-toggle="collapse" href="#collapseExample1" role="button" aria-expanded="true" aria-controls="collapseExample1" class="btn btn-primary btn-block py-2 shadow-sm with-chevron">
                                <p class="d-flex align-items-center justify-content-between mb-0 px-3 py-2"><strong class="text-uppercase">Collapse Panel</strong><i class="fa fa-angle-down"></i></p>
                            </a>

                            <div id="collapseExample1" class="collapse shadow-sm show">
                                <div class="card">
                                    <div class="card-body">
                                        <p class="font-italic mb-0 text-muted">Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea proident.</p>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>*@
            

            <div class="x_panel">
                <div class="x_title">
                    <h2>Grupos de permisos</h2>

                    <div class="clearfix"></div>
                </div>
                @{
                    int grupo = 0;
                    int countElement = @Model.Operaciones.Count();
                    int counter = 0;
                }

                <div class="container md-10">
                    <div class="py-5">
                        <div class="row">
                            @foreach (var operacion in Model.Operaciones)
                            {

                                counter++;

                                if (grupo != operacion.Grupo)
                                {
                                    if (grupo != 0)
                                    {
                                        @Html.Raw("</div> </div> </div> </div>")
                                    }

                                    @Html.Raw("<div class=\"col-lg-6 mb-5\">")

                                    <a data-toggle="collapse" href="@Html.Raw("#collapseExample" + grupo)" role="button" aria-expanded="true" aria-controls="collapseExample1" class="btn btn-primary btn-block py-2 shadow-sm with-chevron">
                                        <p class="d-flex align-items-center justify-content-between mb-0 px-3 py-2"><strong class="text-uppercase">@Operacion.Grupos[operacion.Grupo - 1] <i id="@Html.Raw("check-grupo-" + (grupo+1))" class="fa fa-check check-group" style="display: none;"></i> </strong><i class="fa fa-angle-down"></i></p>
                                    </a>

                                    @Html.Raw(" <div id=\"collapseExample" + grupo +"\" class=\"collapse shadow-sm \"> <div class=\"card\"> <div class=\"card-body\">")

                                    <div class="custom-control custom-checkbox my-1 mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="Role.ListaOperaciones[]" id="@operacion.Codigo" value="@operacion.IdOperacion">
                                        <label class="custom-control-label" for="@operacion.Codigo">@operacion.Nombre</label>
                                        <br />
                                        <small>@operacion.Descripcion</small>
                                    </div>
                                    grupo = operacion.Grupo;
                                }
                                else
                                {
                                    <div class="custom-control custom-checkbox my-1 mr-sm-2">
                                        <input type="checkbox" class="custom-control-input" name="Role.ListaOperaciones[]" id="@operacion.Codigo" value="@operacion.IdOperacion">
                                        <label class="custom-control-label" for="@operacion.Codigo">@operacion.Nombre</label>
                                        <br />
                                        <small>@operacion.Descripcion</small>
                                    </div>
                                    if (countElement == counter)
                                    {
                                        @Html.Raw("</div> </div> </div> </div>")
                                    }
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="item form-group" style="float: right;">
                <div class="col-md-6 col-sm-6 offset-md-3">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </div>
            }
    </div>
</div>

<script>

    $(document).ready(function () {

        let idrole = @Html.Raw(Json.Encode(Model.Role.IdRole));
        console.log(idrole);
        if (idrole !== 0) {
            searchRoleOperaciones(idrole);
            $('#role-select option[value="' + idrole + '"]').attr("selected", "selected");
        }

    });

    $("#role-select").change(function () {
        let roleId = $(this).children("option:selected").val();
        console.log(roleId);
        if (roleId != 0) {
            searchRoleOperaciones(roleId);
        }
    });

    async function searchRoleOperaciones(roleId) {
       
        try {
            const res = await BuscarRoleOperaciones(roleId);
            let array = JSON.parse(res);
            console.log(array);

            $(':checkbox').prop("checked", false);
            $(':checkbox').removeAttr("checked", "checked");

            $('.check-group').hide();

            for (var item in array) {
                $(':checkbox[value="' + array[item].IdOperacion.toString() + '"]').prop("checked", true);
                $(':checkbox[value="' + array[item].IdOperacion.toString() + '"]').attr("checked", "checked");

                
                $('#check-grupo-' + array[item].Grupo).show();

                console.log('supeer', $('#check-grupo-' + array[item].Grupo).show());

                console.log($(':checkbox[value="' + array[item].IdOperacion.toString() + '"]'));
            }

        } catch (err) {
        }
    }

    function BuscarRoleOperaciones(idRole) {

        let dataValue = { "idRole": idRole };

        return $.ajax({
            type: "get",
            url: "/Roles/BuscarRoleOperaciones",
            data: dataValue,
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log("Request: " + XMLHttpRequest.toString() + "\n\nStatus: " + textStatus + "\n\nError: " + errorThrown);
            },
            complete: function (jqXHR, status) {
            }
        });
    }

</script>



