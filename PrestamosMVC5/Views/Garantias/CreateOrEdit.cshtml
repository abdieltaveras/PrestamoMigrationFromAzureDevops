
@model GarantiaVM
@section pagestyle
{
    @*<link href="/Content/vendors/iCheck/skins/flat/green.css" rel="stylesheet" />*@
    <style>
        p strong {
            pointer-events: none;
        }

        p span {
            pointer-events: none;
        }

            p span span {
                pointer-events: none;
            }

        i {
            pointer-events: none;
        }
    </style>
}
<link href="~/Content/customcss/switch.css" rel="stylesheet">

<div class="clearfix"></div>
<div>
    @*<form autocomplete="off" action="/" method="post" style="padding: 0%">*@
    <div class="col-5" style="margin: auto; padding: 0%; ">
        <h4 style="text-align: center;">¿Que garantia buscas?</h4>
        <input class="garantia_target form-control" type="text" autocomplete="off" id="search-garantia-input" placeholder="Buscar por numero de identificacion..." name="name" value=""
               style="height: 60px" />
        <div id="list-garantia-container">
            <div class="list-group col-md-12" id="list-garantia-tab" role="tablist" style="position: absolute; z-index:2; padding: 0%; vertical-align: middle;">
            </div>
        </div>
    </div>
    @*</form>*@
</div>
<br />

<div class="row">
    <div class="col-md-12">
        <div class="x_panel">

            <div class="x_content">
                <div>
                    <div class="x_title">
                        <h2>Garantia </h2>
                        <div style="float:right;">
                            @if (Model.ListaMensajes != null)
                            {
                                <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#errorModal">Ver errores</button>
                            }
                            <button type="button" class="btn btn-primary" id="btnFormTasaInteres" onclick="clearForm()">Nuevo</button>
                        </div>

                        <div class="clearfix"></div>
                    </div>
                    <div class="col-md-6 col-md-12">

                        @* Formulario de garantia *@

                        <div class="x_content">
                            <br>

                            @using (Html.BeginForm("CreateOrEdit", "Garantias", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "", role = "form", @id = "garantia" }))
                            {

                                <h6>Clasificacion de garantia</h6>
                                <div class="@HtmlClass.FormGroupCls">
                                    <div class="@HtmlClass.DivInputCls">
                                        <input type="radio" class="flat" name="Garantia.IdClasificacion" checked id="inmobiliario_option" value="1" style="float:right;" />
                                        <i class="fa fa-home"></i> Inmobiliriario
                                        <br />
                                        <input type="radio" class="flat" name="Garantia.IdClasificacion" id="mobiliario_option" value="2" style="float:right;" />
                                        <i class="fa fa-car"></i> Mobiliriario
                                    </div>

                                </div>
                                <hr />

                                //Datos iniciales formulario

                                <div class="row">
                                    <div class="col-md-6">

                                        @*<input class="form-control" type="hidden" id="IdGarantia" name="IdGarantia">*@
                                        @Html.HiddenFor(model => model.Garantia.IdGarantia)
                                        @Html.HiddenFor(model => model.Garantia.IdNegocio)

                                        @*<input type="hidden" value="-1" id="Garantia_IdGarantia" name="Garantia.IdGarantia" />*@



                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="noidentificacion">
                                                Numero de identificacion <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.NoIdentificacion, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls }, @required = true })
                                                <span class="input-group-btn" style="color: dodgerblue;">
                                                    (Generar codigo automatico)
                                                </span>
                                            </div>

                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="tipo">
                                                Tipo <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                <select name="Garantia.IdTipoGarantia" class="form-control" id="Garantia_IdTipo">
                                                    <option value="0">Elije una opcion</option>
                                                </select>

                                                @*@Html.DropDownListFor(model => model.Garantia.IdTipo, Model.ListaTipos, htmlAttributes: new { @class = @HtmlClass.FormControlCls })*@

                                                @*@Html.EditorFor(model => model.Garantia.IdTipo, new { htmlAttributes = new { @class = @HtmlClass.FormControlCls } })*@
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-md-6">

                                    </div>
                                </div>

                                <hr />

                                // fin de datos iniciales

                                @* Formulario de inmobiliario *@

                                <div class="row" id="inmobiliario_form_container">
                                    <div class="col-md-6">
                                        <div class="form-group row" style="padding: 0%">
                                            <label class="col-sm-4 col-form-label" for="Direccion_Calle">Localidad</label>
                                            <div class="col-sm-8" style="margin: auto;">

                                                <input class="target form-control" type="text" id="searchLocalidad" name="searchLocalidad" placeholder="Busca una direccion" autocomplete="off" />
                                                <span id="rutadelocalidad"></span>
                                                <div id="list-address-container" style=" padding: 0%;">
                                                    <div class="list-group col-md-12 col-sm-12 col-xs-12" id="list-tab" role="tablist" style="position: absolute; z-index:2; padding-right: 20px; padding-left: 0px; vertical-align: middle;">
                                                    </div>
                                                </div>

                                                <span class="field-validation-valid text-danger" data-valmsg-for="Direccion.Calle" data-valmsg-replace="true"></span>
                                                <span class="fa fa-home form-control-feedback right" aria-hidden="true"></span>
                                            </div>
                                        </div>

                                        <input type="hidden" class="target form-control" name="Garantia.DetallesJSON.IdLocalidad" id="Direccion_IdLocalidad" />

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="interes">
                                                Detalles de direccion <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">

                                                <textarea class="form-control rounded-0" name="Garantia.DetallesJSON.DetallesDireccion" id="InputRutaLocalidad" rows="3"></textarea>

                                                @*<textarea name="Garantia.DetallesJSON.DetallesDireccion" class="form-control" id="InputRutaLocalidad" value="" />*@

                                            </div>
                                        </div>


                                        @*<input type="text" class="target form-control" id="InputRutaLocalidad" placeholder="Aqui cargara la ruta" />*@


                                    </div>

                                    <div class="col-md-6">

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="localidad">
                                                Medida <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.DetallesJSON.Medida, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls } })
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                @* Fin formulario de Inmobiliario *@

                                @* Formulario de mobiliario *@

                                <div class="row" id="mobiliario_form_container">
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="marca">
                                                Marca <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @*@Html.EditorFor(model => model.Garantia.IdMarca, new { htmlAttributes = new { @class = @HtmlClass.FormControlCls } })*@
                                                @* @Html.DropDownListFor(model => model.Garantia.IdMarca, Model.ListaMarcas, htmlAttributes: new { @class = @HtmlClass.InputTextCls })*@
                                                @*@foreach (var item in Model.ListaMarcas)
                                                    {
                                                    <p>@item</p>
                                                    }*@
                                                <select name="Garantia.IdMarca" class="form-control" id="Garantia_IdMarca">
                                                    <option value="0">Elije una marca</option>
                                                    @foreach (var marca in Model.ListaMarcas)
                                                    {
                                                        <option value="@marca.IdMarca">@marca.Nombre</option>
                                                    }
                                                </select>

                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="modelo">
                                                Modelo <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @*@Html.DropDownListFor(model => model.Garantia.IdModelo, Model.ListaModelos, htmlAttributes: new { @class = @HtmlClass.InputTextCls })*@
                                                <select name="Garantia.IdModelo" class="form-control" id="Garantia_IdModelo">
                                                    <option value="0">Elije una modelo</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="modelo">
                                                Colores <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.DropDownListFor(model => model.Garantia.DetallesJSON.Color, Model.ListaColores, htmlAttributes: new { @class = @HtmlClass.InputTextCls })

                                                @* @Html.EditorFor(model => model.Garantia.IdModelo, new { htmlAttributes = new { @class = @HtmlClass.FormControlCls } })*@
                                            </div>
                                        </div>


                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="NoMaquina">
                                                No. Maquina <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.DetallesJSON.NoMaquina, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls } })
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="año">
                                                Año <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.DetallesJSON.Ano, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls } })
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="placa">
                                                Placa <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.DetallesJSON.Placa, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls } })
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="matricula">
                                                Matricula <span class="required">*</span>
                                            </label>
                                            <div class="col-sm-8">
                                                @Html.EditorFor(model => model.Garantia.DetallesJSON.Matricula, new { htmlAttributes = new { @class = @HtmlClass.InputTextCls } })
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                @* Fin formulario de mobiliario *@

                                @* Formulario de datos en comun *@

                                <hr />

                                <div class="row" id="common_form_container">
                                    <div class="col-md-6">

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="valor">
                                                Valor <span class="required"></span>
                                            </label>
                                            <div class="col-sm-8">
                                                <input type="number" class="form-control text-box single-line" name="Garantia.DetallesJSON.Valor" id="Garantia_DetallesJSON_Valor">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label" for="interes">
                                                Descripcion <span class="required"></span>
                                            </label>
                                            <div class="col-sm-8">
                                                <textarea class="form-control rounded-0" name="Garantia.DetallesJSON.Descripcion" id="Garantia_DetallesJSON_Descripcion" rows="3"></textarea>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">
                                                ¿Puedo usar esta garantia en mas de 1 transaccion? <span class="required"></span>
                                            </label>
                                            <div class="col-sm-8">

                                                <input data-val="true"
                                                       class="checkbox"
                                                       id="Garantia_DetallesJSON_UsoExclusivo"
                                                       name="Garantia.DetallesJSON.UsoExclusivo"
                                                       type="checkbox"
                                                       value="true" />
                                                <label for="Garantia_DetallesJSON_UsoExclusivo" class="switch" id="switch"></label>

                                            </div>
                                        </div>

                                    </div>

                                    <div class="col-md-6">

                                    </div>
                                </div>
                                @* Fin formulario de datos en comun *@
                                
                                if(Permission.Has("garantias-create"))
                                {
                                    <div class="ln_solid"></div>
                                    <div class="item form-group">
                                        <div class="col-md col-sm-6">
                                            <button type="submit" class="btn btn-primary" style="float:right;">Guardar</button>
                                        </div>
                                    </div>
                                }
                            }
                            @*</form>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de errores -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Lista de errores</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                @if (Model.ListaMensajes != null)
                {
                    foreach (var error in Model.ListaMensajes)
                    {
                        <div class="alert alert-danger alert-dismissible " role="alert">
                            @*<button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>*@
                            <strong>Error: </strong> @error.Mensaje
                        </div>
                    }
                }
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
            <img src="~/Content/ImagesFor/Negocios/Papito.png" />
        </div>
    </div>
</div>
@section scripts
{
    <script>
    let formulario = $("#garantia");
    let searchLocalidadElem = $('#searchLocalidad');
    let selectPointer = 0;


    $(document).ready(function () {
        //$('input').iCheck({
        //    checkboxClass: 'icheckbox_flat-green',
        //    radioClass: 'iradio_flat-green'
        //});

        $('#mobiliario_form_container').hide();
        loadTipo(2);

        $('input').on('ifChecked', function (event) {
            console.log(event.target.id);

            if (event.target.id === 'mobiliario_option') {
                $('#mobiliario_form_container').show();
                $('#inmobiliario_form_container').hide();
                loadTipo(1);
                clearForm();

            } else if (event.target.id === 'inmobiliario_option') {
                $('#mobiliario_form_container').hide();
                $('#inmobiliario_form_container').show();
                loadTipo(2);
                clearForm();
            }
        });
    });

    //// Buscador de garantias
    const onGarantiaEnter = async function () {
        let idGarantia = $('[data-order="' + selectPointer + '"]').attr('data-idGarantia');
        setDataOnField(idGarantia);
    };
    const onGarantiaClick = async function (evt) {
        let idGarantia = evt.currentTarget.getAttribute('data-idGarantia');
        console.log('super', evt)
        setDataOnField(idGarantia);
    };

    async function setDataOnField(idgarantia) {
        const selectedGarantia = JSON.parse(garantiaRes).find(Garantia => Garantia.IdGarantia == idgarantia);
        const detalles = JSON.parse(selectedGarantia.Detalles);

        console.table(detalles);

        if (selectedGarantia.IdClasificacion === 1) {
            $('#inmobiliario_option').iCheck('check');
            console.log('Cargue una casa');
            loadTipo(2);
        } else {
            $('#mobiliario_option').iCheck('check');
            console.log('Cargue un carro');

            loadTipo(1);
        }
        $('#Garantia_IdGarantia').val(selectedGarantia.IdGarantia);

        $('#Garantia_NoIdentificacion').val(selectedGarantia.NoIdentificacion);
        $('#Garantia_IdNegocio').val(selectedGarantia.IdNegocio);

        $('#Garantia_IdTipo option[value="' + selectedGarantia.IdTipoGarantia + '"]').attr("selected", "selected");

        $('#Garantia_IdMarca').val(selectedGarantia.IdMarca);
        //$('#Garantia_IdMarca option[value="' + selectedGarantia.IdMarca + '"]').attr("selected", "selected");
        loadModelos(selectedGarantia.IdMarca, selectedGarantia.IdModelo);

        $('#Direccion_IdLocalidad').val(detalles.IdLocalidad);
        $('#Garantia_DetallesJSON_DetallesDireccion').val(detalles.DetallesDireccion);
        $('#Garantia_DetallesJSON_Medida').val(detalles.Medida);
        $('#Garantia_DetallesJSON_Color').val(detalles.Color);
        $('#Garantia_DetallesJSON_NoMaquina').val(detalles.NoMaquina);
        $('#Garantia_DetallesJSON_Ano').val(detalles.Ano);
        $('#Garantia_DetallesJSON_Placa').val(detalles.Placa);
        $('#Garantia_DetallesJSON_Matricula').val(detalles.Matricula);
        $('#Garantia_DetallesJSON_Valor').val(detalles.Valor);
        $('#Garantia_DetallesJSON_Descripcion').val(detalles.Descripcion);


        if (detalles.UsoExclusivo) {
            $('#Garantia_DetallesJSON_UsoExclusivo').prop("checked", true);
            $('#Garantia_DetallesJSON_UsoExclusivo').attr("checked", "checked");
        } else {
            $('#Garantia_DetallesJSON_UsoExclusivo').prop("checked", false);
            $('#Garantia_DetallesJSON_UsoExclusivo').removeAttr("checked", "checked");
        }

        // Buscar nombre de la localidad con el ID
        let resLocalidad;
        if (detalles.IdLocalidad != 0) {
            resLocalidad = await searchLocalidadGarantia(detalles.IdLocalidad, selectedGarantia.IdNegocio);
        }

        $('#Garantia_NoIdentificacion').focus();
        $('#searchLocalidad').val(resLocalidad);
        $('#list-garantia-container').hide();

        $('.garantias').remove();
        $('#searchinput').val(null);
    }

    function searchLocalidadGarantia(IdLocation, IdNegocio) {

        let dataValue = {
            "IdLocalidad": IdLocation,
            "IdNegocio": IdNegocio
        };

        return $.ajax({
            type: "get",
            url: "/Garantias/BuscarLocalidadGarantias",
            data: dataValue,
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log("Request: " + XMLHttpRequest.toString() + "\n\nStatus: " + textStatus + "\n\nError: " + errorThrown);
            },
            complete: function (jqXHR, status) {
            }
        });
    }

    function loadTipo(type) {
        var data = @Html.Raw(Json.Encode(Model.ListaTiposReal));

        $('.typeoption').remove();

        if (type === 1) {
        // Cargar los tipos inmobiliarios

            for (var i in data) {
                if (data[i].IdClasificacion == 1) {
                    $('#Garantia_IdTipo').append(`<option class="typeoption" value="${data[i].IdTipoGarantia}">${data[i].Nombre}</option>`);
                }
            }

        } else {
            // Cargar los tipos mobiliarios
            for (var i in data) {
                if (data[i].IdClasificacion == 2) {
                    $('#Garantia_IdTipo').append(`<option class="typeoption" value="${data[i].IdTipoGarantia}">${data[i].Nombre}</option>`);
                }
            }
        }
    }

    $("#Garantia_IdMarca").change(async function () {
        loadModelos(null, null);
    });

    async function loadModelos(marcaid, modeloid) {
        let id = null
        if (marcaid === null) {
            id = $('#Garantia_IdMarca').children("option:selected").val();
        } else {
            id = marcaid;
        }
        let response = await searchModeloOfMarca(id);

        showListModelosByMarca( JSON.parse(response), modeloid);
    }

    function searchModeloOfMarca(idMarca) {
        let dataValue = { "idMarca": idMarca };
        return $.ajax({
            type: "get",
            url: "/Modelos/BuscarModelosDeMarcas",
            data: dataValue,
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                console.log("Request: " + XMLHttpRequest.toString() + "\n\nStatus: " + textStatus + "\n\nError: " + errorThrown);
            },
            complete: function (jqXHR, status) {
            }
        });
    }

    function showListModelosByMarca(lista, modeloid) {
        $('#Garantia_IdModelo').empty();

        $.each(lista, function (index, value) {
            $('#Garantia_IdModelo').append(`<option value="${value.IdModelo}">${value.Nombre}</option>`);
        });
        if (modeloid !== null) {
            $('#Garantia_IdModelo').val(modeloid);
        }
    }


    function clearForm() {

        $('#Garantia_IdGarantia').val('');
        $('#Garantia_NoIdentificacion').val("");
        $('#Garantia_IdNegocio').val("");

        //$('#IdModelo').val("");
        //$('#IdMarca').val("");

        $('#Direccion_IdLocalidad').val("");
        $('#InputRutaLocalidad').val("");

        $('#Garantia_DetallesJSON_Medida').val("");
        $('#Garantia_DetallesJSON_Color').val("");
        $('#Garantia_DetallesJSON_NoMaquina').val("");
        $('#Garantia_DetallesJSON_Ano').val("");
        $('#Garantia_DetallesJSON_Placa').val("");
        $('#Garantia_DetallesJSON_Matricula').val("");
        $('#Garantia_DetallesJSON_Valor').val("");
        $('#Garantia_DetallesJSON_Descripcion').val("");

        $('#Garantia_DetallesJSON_UsoExclusivo').prop("checked", false);
        $('#Garantia_DetallesJSON_UsoExclusivo').removeAttr("checked", "checked");

        $('#searchLocalidad').val('');
    }
    </script>
    <script src="~/Scripts/Apps/searchLocalidad.js"></script>
    <script src="~/Scripts/Apps/Garantia/search.js"></script>

    @*<script src="/Content/vendors/iCheck/icheck.min.js"></script>*@
}

